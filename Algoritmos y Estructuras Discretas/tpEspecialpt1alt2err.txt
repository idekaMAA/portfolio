#include <iostream>
#include <cstdio>

using namespace std;

// Estructuras
struct Formula {
    int numList;
    char nomPresi[30];
    char nomVPresi[30];
};

struct archVotos {
    int provincia;
    int partido;
    int localidad;
    int blancos;
    int impugnados;
    int listas[5];
};

struct Votos {
    int padron;
    int blancos;
    int impugnados;
    int listas[5];
};

Votos matrizVotos[24][10][20];

// Declaración de funciones
void presidente(Formula formulas[5]);
void cargarVotos(FILE *archivo);
void cargarFormulas(FILE *archivo, Formula formulas[5]);
void gobernador();
void intendente();
void ausentismo();
void votosBlancos();
void votosImpugnados();

// Main
int main() {
    Formula formulas[5];

    // Abrir archivos (hay 1 archivo por cada escenario posible)
    FILE *archiVotos = fopen("archVotos_45.bin", "rb"); //para probar los distintos archivos, debe reemplazar
    FILE *archiFormulas = fopen("Listas.bin", "rb");    // "45" por "none" o "4010" none:hará falta 2da vuelta

    if (!archiVotos) {
        cerr << "Error al abrir el archivo de votos." << endl;
        return 1;
    }

    if (!archiFormulas) {
        cerr << "Error al abrir el archivo de formulas." << endl;
        return 1;
    }

    // Cargar datos
    cargarVotos(archiVotos);
    cargarFormulas(archiFormulas, formulas);

    // Cerrar archivos
    fclose(archiVotos);
    fclose(archiFormulas);

    // Determinar fórmula ganadora
    presidente(formulas);
    cout <<endl;
    cout <<endl;
    gobernador();
    cout <<endl;
    cout <<endl;
    intendente();
    cout <<endl;
    cout <<endl;
    ausentismo();
    cout <<endl;
    votosBlancos();
    cout <<endl;
    votosImpugnados();
    cout <<endl;

    return 0;
}

// Función para cargar votos
void cargarVotos(FILE *archivo) {
    archVotos registro;
    while (fread(&registro, sizeof(archVotos), 1, archivo)) {
        int p = registro.provincia;
        int pa = registro.partido;
        int l = registro.localidad;

        if (p < 24 && pa < 10 && l < 20) {
            matrizVotos[p][pa][l].padron = 0;
            matrizVotos[p][pa][l].blancos = registro.blancos;
            matrizVotos[p][pa][l].impugnados = registro.impugnados;

            for (int i = 0; i < 5; i++) {
                matrizVotos[p][pa][l].listas[i] = registro.listas[i];
                matrizVotos[p][pa][l].padron += registro.listas[i];
            }
            matrizVotos[p][pa][l].padron += registro.blancos + registro.impugnados;
        }
    }
}

// Función para cargar las fórmulas presidenciales
void cargarFormulas(FILE *archivo, Formula formulas[5]) {
    for (int i = 0; i < 5; i++) {
        if (fread(&formulas[i], sizeof(Formula), 1, archivo) != 1) {
            cerr << "Error: el archivo no contiene suficientes datos." << endl;
            return;
        }
    }
}

// Función para determinar el presidente
void presidente(Formula formulas[5]) {
    int votPosE[5] = {0};
    int votosTotales = 0;

    for (int i = 0; i < 24; i++) {
        for (int j = 0; j < 10; j++) {
            for (int k = 0; k < 20; k++) {
                for (int t = 0; t < 5; t++) {
                    votPosE[t] += matrizVotos[i][j][k].listas[t];
                    votosTotales += matrizVotos[i][j][k].listas[t];
                }
            }
        }
    }

    // Determinar el ganador y el segundo lugar
    int ganador = -1, seg = -1;
    double maxPorcentaje = 0.0, segPorcentaje = 0.0;
    double porcentajes[5] = {0};

    for (int z = 0; z < 5; z++) {
        porcentajes[z] = (votPosE[z] * 100.0) / votosTotales;
        if (porcentajes[z] > maxPorcentaje) {
            seg = ganador;
            segPorcentaje = maxPorcentaje;
            ganador = z;
            maxPorcentaje = porcentajes[z];
        } else if (porcentajes[z] > segPorcentaje) {
            seg = z;
            segPorcentaje = porcentajes[z];
        }
    }

    // Verificación de victoria en primera vuelta
    if (maxPorcentaje >= 45 || (maxPorcentaje >= 40 && (maxPorcentaje - segPorcentaje) >= 10)) {
        cout << "Presidente electo: " << formulas[ganador].nomPresi
             << " con " << maxPorcentaje << "% de los votos." << endl;
    } else {
        cout << "Es necesaria una segunda vuelta." << endl;
    }
}

void gobernador(){
    for (int p=0; p<24;p++){
        int votList[5]={0};

        for (int j=0; j<10; j++){
            for (int k=0; k<20; k++){
                for (int t=0; t<5; t++){
                    votList[t]+= matrizVotos[p][j][k].listas[t];
                }
            }
        }
        int ganador=0;
        for(int z=1; z<5; z++){
            if(votList[z] > votList[ganador]){
                ganador = z;
            }
        }
        cout << "Gobernador electo en provincia "<< p+1<< " es de la lista: "<<ganador+1<<" con "<< votList[ganador]<<" votos"<<endl;
    }
}

void intendente(){
    for (int p=0; p<24; p++){
        for (int l=0; l<10; l++){
            int votListal[5]={0};

            for (int j=0; j<20; j++){
                for (int k=0; k<5; k++){
                    votListal[k] += matrizVotos[p][l][j].listas[k];
                }
            }

            int ganador = 0;
            for(int t = 1; t<5; t++){
                if (votListal[t] > votListal[ganador]){
                    ganador = t;
                }
            }
            cout << "Intendente electo en la localidad "<<l+1<<" de la provincia "<<p+1<<" es de la lista "<< ganador+1<< " con "<<votListal[ganador] << " votos."<< endl;
        }
        cout <<endl;
    }
}

void ausentismo() {
    int totPadron = 0, totVotantes = 0;
    for (int p = 0; p < 24; p++) {
        int totalAusentesProv = 0, totalPadronProv = 0;
        for (int j = 0; j < 10; j++) {
            for (int k = 0; k < 20; k++) {
                totPadron += matrizVotos[p][j][k].padron;
                totVotantes += matrizVotos[p][j][k].padron - (matrizVotos[p][j][k].blancos + matrizVotos[p][j][k].impugnados);
                totalPadronProv += matrizVotos[p][j][k].padron;
                totalAusentesProv += matrizVotos[p][j][k].blancos + matrizVotos[p][j][k].impugnados;
            }
        }
        double porcentajeProv = (totalAusentesProv * 100.0) / totalPadronProv;
        cout << "Provincia " << p + 1 << " - Porcentaje de ausentismo: " << porcentajeProv << "%" << endl;
    }
    double porcentajeAusentismo = 100.0 - ((totVotantes * 100.0) / totPadron);
    cout << "Porcentaje de ausentismo a nivel nacional: " << porcentajeAusentismo << "%" << endl;
}


void votosBlancos() {
    int totalPadronNac = 0, totalBlancosNac = 0;
    for (int p = 0; p < 24; p++) {
        int totalBlancosProv = 0;
        for (int j = 0; j < 10; j++) {
            for (int k = 0; k < 20; k++) {
                totalPadronNac += matrizVotos[p][j][k].padron;
                totalBlancosNac += matrizVotos[p][j][k].blancos;
                totalBlancosProv += matrizVotos[p][j][k].blancos;
            }
        }
        cout << "Provincia " << p + 1 << " - Votos en blanco: " << totalBlancosProv << endl;
    }
    double porcentajeNacional = (totalBlancosNac * 100.0) / totalPadronNac;
    cout << "A nivel nacional - Votos en blanco: " << porcentajeNacional << "%" << endl;
}

void votosImpugnados() {
    int totalPadronNac = 0, totalImpugnadosNac = 0;
    for (int p = 0; p < 24; p++) {
        int totalImpugnadosProv = 0;
        for (int j = 0; j < 10; j++) {
            for (int k = 0; k < 20; k++) {
                totalPadronNac += matrizVotos[p][j][k].padron;
                totalImpugnadosNac += matrizVotos[p][j][k].impugnados;
                totalImpugnadosProv += matrizVotos[p][j][k].impugnados;
            }
        }
        cout << "Provincia " << p + 1 << " - Votos impugnados: " << totalImpugnadosProv << endl;
    }
    double porcentajeNacional = (totalImpugnadosNac * 100.0) / totalPadronNac;
    cout << "A nivel nacional - Votos impugnados: " << porcentajeNacional << "%" << endl;
}
